<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Detalle del Producto - Áurea</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Rethink+Sans:ital,wght@0,400..800;1,400..800&display=swap" rel="stylesheet">
    
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: {
                        'sans': ['"Rethink Sans"', 'sans-serif'],
                    },
                    colors: {
                        'aurea-gold': '#BB9F6F',
                        'aurea-charcoal': '#222222',
                        'aurea-white': '#FFFFFF',
                        'aurea-neutral-gray': '#D3D3D3',
                    }
                }
            }
        }
    </script>

    <style>
        body { font-family: '"Rethink Sans"', sans-serif; background-color: #FFFFFF; }
        .star-rating label { cursor: pointer; }
        .star-rating input[type="radio"]:checked ~ label,
        .star-rating:not(:checked) > label:hover,
        .star-rating:not(:checked) > label:hover ~ label { color: #facc15; /* yellow-400 */ }
    </style>
</head>
<body class="text-aurea-charcoal antialiased">

    <!-- Encabezado -->
    <header class="bg-aurea-white shadow-sm sticky top-0 z-50">
        <nav class="container mx-auto px-4 sm:px-6 lg:px-8">
            <div class="flex items-center justify-between h-16">
                 <a href="index.html" class="flex items-center justify-center space-x-2 group">
                    <svg class="h-8 w-8 text-aurea-charcoal" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M5 6.25C5 5.00736 6.00736 4 7.25 4H16.75C17.9926 4 19 5.00736 19 6.25V17.75C19 18.9926 17.9926 20 16.75 20H7.25C6.00736 20 5 18.9926 5 17.75V6.25Z" stroke="#222222" stroke-width="1.5"/><path d="M9 4V2" stroke="#222222" stroke-width="1.5" stroke-linecap="round"/><path d="M15 4V2" stroke="#222222" stroke-width="1.5" stroke-linecap="round"/><path d="M12 10V16" stroke="#BB9F6F" stroke-width="2" stroke-linecap="round"/><path d="M9 13H15" stroke="#BB9F6F" stroke-width="2" stroke-linecap="round"/></svg>
                    <span class="text-2xl font-bold text-aurea-charcoal tracking-tight">Áurea</span>
                </a>
                <div class="hidden md:block">
                    <div class="ml-10 flex items-baseline space-x-4">
                        <a href="index.html" class="text-aurea-charcoal hover:text-aurea-gold px-3 py-2 rounded-md text-sm font-medium transition">Inicio</a>
                        <a href="#" class="text-aurea-charcoal hover:text-aurea-gold px-3 py-2 rounded-md text-sm font-medium transition">Tienda</a>
                    </div>
                </div>
                <div class="hidden md:block">
                    <div class="ml-4 flex items-center md:ml-6 space-x-2">
                        <a href="login.html" class="text-aurea-charcoal hover:bg-aurea-neutral-gray/50 font-medium py-2 px-4 rounded-lg text-sm transition">Iniciar Sesión</a>
                        <a href="register.html" class="bg-aurea-charcoal text-aurea-white font-medium hover:bg-aurea-charcoal/90 py-2 px-4 rounded-lg text-sm transition shadow-sm">Registrarse</a>
                    </div>
                </div>
            </div>
        </nav>
    </header>

    <main class="container mx-auto px-4 sm:px-6 lg:px-8 py-12">
        <div id="product-detail-container" class="grid grid-cols-1 md:grid-cols-2 gap-12 items-start">
            <!-- Loading Skeleton -->
            <div id="loading-placeholder">
                <div class="animate-pulse flex-1 space-y-4">
                    <div class="bg-gray-200 h-96 w-full rounded-lg"></div>
                </div>
            </div>
            <div id="loading-placeholder-text">
                 <div class="animate-pulse flex-1 space-y-4">
                    <div class="h-4 bg-gray-200 rounded w-1/4"></div>
                    <div class="h-8 bg-gray-200 rounded w-3/4"></div>
                    <div class="h-10 bg-gray-200 rounded w-1/3 mt-4"></div>
                    <div class="h-4 bg-gray-200 rounded w-1/5 mt-8"></div>
                    <div class="flex space-x-2">
                        <div class="h-8 w-8 bg-gray-200 rounded-full"></div>
                        <div class="h-8 w-8 bg-gray-200 rounded-full"></div>
                    </div>
                 </div>
            </div>
        </div>

        <!-- Sección de Reseñas -->
        <div id="reviews-section" class="mt-16 pt-10 border-t border-aurea-neutral-gray hidden">
            <h2 class="text-2xl font-bold tracking-tight text-aurea-charcoal">Reseñas y Evaluaciones</h2>
            
            <!-- Formulario para dejar una reseña -->
            <div class="mt-6 bg-aurea-neutral-gray/20 p-6 rounded-lg">
                <h3 class="text-lg font-semibold">Deja tu reseña</h3>
                <form id="review-form" class="mt-4 space-y-4">
                    <div>
                        <label class="block text-sm font-medium">Tu evaluación</label>
                        <div class="star-rating flex flex-row-reverse justify-end text-3xl text-gray-300">
                            <input type="radio" id="star5" name="rating" value="5" class="hidden" /><label for="star5" title="5 stars">★</label>
                            <input type="radio" id="star4" name="rating" value="4" class="hidden" /><label for="star4" title="4 stars">★</label>
                            <input type="radio" id="star3" name="rating" value="3" class="hidden" /><label for="star3" title="3 stars">★</label>
                            <input type="radio" id="star2" name="rating" value="2" class="hidden" /><label for="star2" title="2 stars">★</label>
                            <input type="radio" id="star1" name="rating" value="1" class="hidden" required/><label for="star1" title="1 star">★</label>
                        </div>
                    </div>
                    <div>
                        <label for="review-comment" class="block text-sm font-medium">Tu comentario</label>
                        <textarea id="review-comment" name="comment" rows="3" required class="mt-1 w-full px-3 py-2 border border-aurea-neutral-gray rounded-md shadow-sm focus:outline-none focus:ring-1 focus:ring-aurea-gold"></textarea>
                    </div>
                    <button type="submit" class="bg-aurea-charcoal text-aurea-white font-medium hover:bg-aurea-charcoal/90 py-2 px-4 rounded-lg text-sm transition shadow-sm">Enviar reseña</button>
                    <div id="review-status" class="text-sm mt-2"></div>
                </form>
            </div>

            <!-- Lista de Reseñas Existentes -->
            <div class="mt-8">
                 <h3 class="text-lg font-semibold">Lo que otros dicen</h3>
                 <div id="reviews-list" class="mt-4 space-y-6">
                    <!-- Las reseñas se cargarán aquí -->
                 </div>
            </div>
        </div>
    </main>

    <footer class="bg-aurea-charcoal text-aurea-white mt-12"><div class="container mx-auto py-8 px-4 sm:px-6 lg:px-8 text-center"><p>&copy; 2024 Áurea. Todos los derechos reservados.</p></div></footer>

    <script type="module">
        import { db, auth } from './firebase-config.js';
        import { onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";
        import { doc, getDoc, collection, addDoc, getDocs, serverTimestamp, query, orderBy } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

        const productDetailContainer = document.getElementById('product-detail-container');
        const reviewForm = document.getElementById('review-form');
        const reviewsList = document.getElementById('reviews-list');
        const reviewStatus = document.getElementById('review-status');
        const reviewsSection = document.getElementById('reviews-section');
        
        let currentUser = null;
        let currentProductId = null;

        onAuthStateChanged(auth, (user) => {
            if (user) {
                currentUser = user;
                const userDocRef = doc(db, "users", user.uid);
                getDoc(userDocRef).then(docSnap => {
                    if (docSnap.exists()) {
                        currentUser.displayName = docSnap.data().fullname;
                    }
                });
            } else {
                currentUser = null;
            }
        });
        
        const displayProductDetails = (product) => {
            const colorsHtml = product.colors && product.colors.length > 0
                ? product.colors.map(color => `<button class="h-8 w-8 rounded-full border-2 border-gray-200 focus:outline-none focus:ring-2 focus:ring-aurea-gold" style="background-color: ${color};" title="${color}"></button>`).join('')
                : '<p class="text-sm text-aurea-charcoal/70">No hay colores especificados.</p>';

            const stockHtml = product.stock !== undefined
                ? (product.stock > 0 
                    ? `<p class="text-sm font-medium ${product.stock < 10 ? 'text-red-600' : 'text-green-600'}">¡Quedan ${product.stock} en stock!</p>` 
                    : '<p class="text-sm font-medium text-red-600">Agotado</p>')
                : '<p class="text-sm font-medium text-aurea-charcoal/70">Disponibilidad no especificada.</p>';
            
            productDetailContainer.innerHTML = `
                <div>
                    <div class="aspect-w-1 aspect-h-1 w-full overflow-hidden rounded-lg bg-gray-200">
                        <img src="${product.imageUrl || 'https://placehold.co/600x600/d3d3d3/222222?text=Producto'}" alt="${product.name}" class="h-full w-full object-cover object-center">
                    </div>
                </div>
                <div class="space-y-6">
                    <div>
                        <p class="text-sm font-medium text-aurea-charcoal/60">${product.category || 'Categoría'}</p>
                        <h1 class="text-3xl font-bold tracking-tight text-aurea-charcoal mt-2">${product.name || 'Nombre del Producto'}</h1>
                    </div>
                    <div><p class="text-4xl font-bold text-aurea-gold">$${product.price ? product.price.toFixed(2) : '0.00'}</p></div>
                    <div class="space-y-2">
                        <h3 class="text-sm font-medium text-aurea-charcoal">Color</h3>
                        <div class="flex items-center space-x-3">${colorsHtml}</div>
                    </div>
                     <div class="space-y-2">
                        <h3 class="text-sm font-medium text-aurea-charcoal">Disponibilidad</h3>
                        ${stockHtml}
                    </div>
                    <div class="space-y-4 text-aurea-charcoal/80 pt-4 border-t">
                        <h2 class="text-lg font-semibold text-aurea-charcoal">Descripción</h2>
                        <p>${product.description || 'No hay descripción disponible.'}</p>
                    </div>
                    <div>
                        <button class="w-full flex justify-center py-3 px-4 border border-transparent rounded-lg shadow-sm text-sm font-bold text-aurea-white bg-aurea-charcoal hover:bg-aurea-charcoal/90 disabled:bg-gray-400 transition" ${product.stock === 0 ? 'disabled' : ''}>
                            ${product.stock === 0 ? 'Agotado' : 'Añadir al Carrito'}
                        </button>
                    </div>
                </div>`;
            reviewsSection.classList.remove('hidden');
        };
        
        const displayReviews = (reviews) => {
            if (reviews.length === 0) {
                reviewsList.innerHTML = '<p class="text-sm text-aurea-charcoal/70">Aún no hay reseñas para este producto. ¡Sé el primero!</p>';
                return;
            }
            reviewsList.innerHTML = reviews.map(review => {
                const stars = '★'.repeat(review.rating) + '☆'.repeat(5 - review.rating);
                return `
                    <div class="border-t border-aurea-neutral-gray/50 pt-4">
                        <div class="flex items-center">
                            <p class="text-yellow-400 text-xl">${stars}</p>
                            <p class="ml-4 font-semibold text-aurea-charcoal">${review.userName || 'Anónimo'}</p>
                        </div>
                        <p class="mt-2 text-aurea-charcoal/80">${review.comment}</p>
                    </div>
                `;
            }).join('');
        };

        const fetchAndDisplayReviews = async (productId) => {
            const reviewsColRef = collection(db, "products", productId, "reviews");
            const q = query(reviewsColRef, orderBy("createdAt", "desc"));
            try {
                const querySnapshot = await getDocs(q);
                const reviews = [];
                querySnapshot.forEach(doc => reviews.push(doc.data()));
                displayReviews(reviews);
            } catch (error) {
                console.error("Error al obtener reseñas:", error);
                reviewsList.innerHTML = '<p class="text-red-600">No se pudieron cargar las reseñas.</p>';
            }
        };

        const fetchProductDetails = async () => {
            const urlParams = new URLSearchParams(window.location.search);
            const productId = urlParams.get('id');
            currentProductId = productId;

            if (!productId) {
                productDetailContainer.innerHTML = '<p class="text-center col-span-full text-red-600 font-semibold">No se ha especificado un producto.</p>';
                return;
            }

            try {
                const docRef = doc(db, "products", productId);
                const docSnap = await getDoc(docRef);

                if (docSnap.exists()) {
                    const productData = docSnap.data();
                    // Log para depuración: Muestra en la consola los datos recibidos
                    console.log("Datos del producto obtenidos de Firebase:", productData);
                    displayProductDetails({ id: docSnap.id, ...productData });
                    await fetchAndDisplayReviews(productId);
                } else {
                    console.log("No se encontró el producto con ID:", productId);
                    productDetailContainer.innerHTML = '<p class="text-center col-span-full text-aurea-charcoal/70">Producto no encontrado.</p>';
                }
            } catch (error) {
                console.error("Error al obtener el producto:", error);
                productDetailContainer.innerHTML = '<p class="text-center col-span-full text-red-600 font-semibold">Error al cargar el producto.</p>';
            }
        };

        reviewForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            if (!currentUser) {
                reviewStatus.textContent = 'Debes iniciar sesión para dejar una reseña.';
                reviewStatus.className = 'text-red-600';
                return;
            }
            
            const rating = reviewForm.rating.value;
            const comment = reviewForm.comment.value;
            const submitButton = reviewForm.querySelector('button');
            
            if (!rating) {
                reviewStatus.textContent = 'Por favor, selecciona una calificación.';
                reviewStatus.className = 'text-red-600';
                return;
            }

            submitButton.disabled = true;
            submitButton.textContent = 'Enviando...';

            try {
                const reviewsColRef = collection(db, "products", currentProductId, "reviews");
                await addDoc(reviewsColRef, {
                    userId: currentUser.uid,
                    userName: currentUser.displayName || 'Usuario de Áurea',
                    rating: Number(rating),
                    comment: comment,
                    createdAt: serverTimestamp()
                });

                reviewForm.reset();
                reviewStatus.textContent = '¡Gracias por tu reseña!';
                reviewStatus.className = 'text-green-600';
                await fetchAndDisplayReviews(currentProductId);

            } catch (error) {
                console.error("Error al enviar reseña:", error);
                reviewStatus.textContent = 'Hubo un error al enviar tu reseña.';
                reviewStatus.className = 'text-red-600';
            } finally {
                submitButton.disabled = false;
                submitButton.textContent = 'Enviar reseña';
                 setTimeout(() => { reviewStatus.textContent = ''; }, 3000);
            }
        });

        document.addEventListener('DOMContentLoaded', fetchProductDetails);
    </script>
</body>
</html>

