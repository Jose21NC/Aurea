<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Detalle del Producto - Áurea</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Rethink+Sans:ital,wght@0,400..800;1,400..800&display=swap" rel="stylesheet">
    
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: {
                        'sans': ['"Rethink Sans"', 'sans-serif'],
                    },
                    colors: {
                        'aurea-gold': '#BB9F6F',
                        'aurea-charcoal': '#222222',
                        'aurea-white': '#FFFFFF',
                        'aurea-neutral-gray': '#D3D3D3',
                    }
                }
            }
        }
    </script>

    <style>
        body { font-family: '"Rethink Sans"', sans-serif; background-color: #FFFFFF; }
        .star-rating label { cursor: pointer; }
        .star-rating input[type="radio"]:checked ~ label,
        .star-rating:not(:checked) > label:hover,
        .star-rating:not(:checked) > label:hover ~ label { color: #facc15; /* yellow-400 */ }
    </style>
</head>
<body class="text-aurea-charcoal antialiased">

    <!-- Encabezado -->
    <header class="bg-aurea-white shadow-sm sticky top-0 z-50">
        <nav class="container mx-auto px-4 sm:px-6 lg:px-8">
            <div class="flex items-center justify-between h-16">
                 <a href="index.html" class="flex items-center justify-center space-x-2 group">
                    <svg class="h-8 w-8 text-aurea-charcoal" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M5 6.25C5 5.00736 6.00736 4 7.25 4H16.75C17.9926 4 19 5.00736 19 6.25V17.75C19 18.9926 17.9926 20 16.75 20H7.25C6.00736 20 5 18.9926 5 17.75V6.25Z" stroke="#222222" stroke-width="1.5"/><path d="M9 4V2" stroke="#222222" stroke-width="1.5" stroke-linecap="round"/><path d="M15 4V2" stroke="#222222" stroke-width="1.5" stroke-linecap="round"/><path d="M12 10V16" stroke="#BB9F6F" stroke-width="2" stroke-linecap="round"/><path d="M9 13H15" stroke="#BB9F6F" stroke-width="2" stroke-linecap="round"/></svg>
                    <span class="text-2xl font-bold text-aurea-charcoal tracking-tight">Áurea</span>
                </a>
                <div class="hidden md:block">
                    <div class="ml-10 flex items-baseline space-x-4">
                        <a href="index.html" class="text-aurea-charcoal hover:text-aurea-gold px-3 py-2 rounded-md text-sm font-medium transition">Inicio</a>
                        <a href="#" class="text-aurea-charcoal hover:text-aurea-gold px-3 py-2 rounded-md text-sm font-medium transition">Tienda</a>
                    </div>
                </div>
                <div class="hidden md:block">
                    <div class="ml-4 flex items-center md:ml-6 space-x-2">
                        <a href="login.html" class="text-aurea-charcoal hover:bg-aurea-neutral-gray/50 font-medium py-2 px-4 rounded-lg text-sm transition">Iniciar Sesión</a>
                        <a href="register.html" class="bg-aurea-charcoal text-aurea-white font-medium hover:bg-aurea-charcoal/90 py-2 px-4 rounded-lg text-sm transition shadow-sm">Registrarse</a>
                    </div>
                </div>
            </div>
        </nav>
    </header>

    <main class="container mx-auto px-4 sm:px-6 lg:px-8 py-12">
        <div id="product-detail-container" class="grid grid-cols-1 md:grid-cols-2 gap-12 items-start">
            <!-- Loading Skeleton -->
            <div id="loading-placeholder">
                <div class="animate-pulse flex-1 space-y-4">
                    <div class="bg-gray-200 h-96 w-full rounded-lg"></div>
                </div>
            </div>
            <div id="loading-placeholder-text">
                 <div class="animate-pulse flex-1 space-y-4">
                    <div class="h-4 bg-gray-200 rounded w-1/4"></div>
                    <div class="h-8 bg-gray-200 rounded w-3/4"></div>
                    <div class="h-10 bg-gray-200 rounded w-1/3 mt-4"></div>
                    <div class="h-4 bg-gray-200 rounded w-1/5 mt-8"></div>
                    <div class="flex space-x-2">
                        <div class="h-8 w-8 bg-gray-200 rounded-full"></div>
                        <div class="h-8 w-8 bg-gray-200 rounded-full"></div>
                    </div>
                 </div>
            </div>
        </div>

        <!-- Sección de Reseñas -->
        <div id="reviews-section" class="mt-16 pt-10 border-t border-aurea-neutral-gray hidden">
            <h2 class="text-2xl font-bold tracking-tight text-aurea-charcoal">Reseñas y Evaluaciones</h2>
            
            <div class="mt-6 bg-aurea-neutral-gray/20 p-6 rounded-lg">
                <h3 class="text-lg font-semibold">Deja tu reseña</h3>
                <form id="review-form" class="mt-4 space-y-4">
                    <div>
                        <label class="block text-sm font-medium">Tu evaluación</label>
                        <div class="star-rating flex flex-row-reverse justify-end text-3xl text-gray-300">
                            <input type="radio" id="star5" name="rating" value="5" class="hidden" /><label for="star5" title="5 stars">★</label>
                            <input type="radio" id="star4" name="rating" value="4" class="hidden" /><label for="star4" title="4 stars">★</label>
                            <input type="radio" id="star3" name="rating" value="3" class="hidden" /><label for="star3" title="3 stars">★</label>
                            <input type="radio" id="star2" name="rating" value="2" class="hidden" /><label for="star2" title="2 stars">★</label>
                            <input type="radio" id="star1" name="rating" value="1" class="hidden" required/><label for="star1" title="1 star">★</label>
                        </div>
                    </div>
                    <div>
                        <label for="review-comment" class="block text-sm font-medium">Tu comentario</label>
                        <textarea id="review-comment" name="comment" rows="3" required class="mt-1 w-full px-3 py-2 border border-aurea-neutral-gray rounded-md shadow-sm focus:outline-none focus:ring-1 focus:ring-aurea-gold"></textarea>
                    </div>
                    <button type="submit" class="bg-aurea-charcoal text-aurea-white font-medium hover:bg-aurea-charcoal/90 py-2 px-4 rounded-lg text-sm transition shadow-sm">Enviar reseña</button>
                    <div id="review-status" class="text-sm mt-2"></div>
                </form>
            </div>

            <div class="mt-8">
                 <h3 class="text-lg font-semibold">Lo que otros dicen</h3>
                 <div id="reviews-list" class="mt-4 space-y-6"></div>
            </div>
        </div>
    </main>
    
    <div id="tryon-modal" class="fixed inset-0 bg-black bg-opacity-75 flex items-center justify-center z-50 hidden">
        <div class="bg-white rounded-lg p-8 max-w-md w-full text-center relative mx-4">
            <button id="close-modal-button" class="absolute top-2 right-3 text-2xl text-gray-500 hover:text-gray-800">&times;</button>
            <div id="modal-loading">
                <h3 class="text-xl font-semibold mb-4 text-aurea-charcoal">Generando tu prueba...</h3>
                <p class="text-aurea-charcoal/70 mb-4">Esto puede tardar un momento. ¡Gracias por tu paciencia!</p>
                <svg class="animate-spin h-10 w-10 text-aurea-gold mx-auto" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                    <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                    <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                </svg>
                 <p id="modal-status-text" class="text-sm text-aurea-charcoal/60 mt-4">Iniciando proceso...</p>
            </div>
            <div id="modal-result" class="hidden">
                 <h3 class="text-2xl font-bold mb-4 text-aurea-charcoal">¡Aquí está tu resultado!</h3>
                 <img id="result-image" src="" alt="Resultado del probador virtual" class="rounded-lg mx-auto max-h-[60vh] object-contain">
            </div>
            <div id="modal-error" class="hidden">
                 <h3 class="text-xl font-semibold mb-4 text-red-600">Hubo un Error</h3>
                 <p id="error-text" class="text-aurea-charcoal/80"></p>
            </div>
        </div>
    </div>

    <footer class="bg-aurea-charcoal text-aurea-white mt-12"><div class="container mx-auto py-8 px-4 sm:px-6 lg:px-8 text-center"><p>&copy; 2024 Áurea. Todos los derechos reservados.</p></div></footer>

    <script type="module">
        import { db, auth, storage } from './firebase-config.js';
        import { onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";
        import { doc, getDoc, collection, addDoc, getDocs, serverTimestamp, query, orderBy, updateDoc } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";
        import { ref, uploadBytes, getDownloadURL } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-storage.js";

        const productDetailContainer = document.getElementById('product-detail-container');
        const reviewForm = document.getElementById('review-form');
        const reviewsList = document.getElementById('reviews-list');
        const reviewStatus = document.getElementById('review-status');
        const reviewsSection = document.getElementById('reviews-section');
        
        let currentUser = null;
        let currentProductId = null;
        let currentProductImageUrl = null;
        let pollingInterval = null;

        const tryOnModal = document.getElementById('tryon-modal');
        const closeModalButton = document.getElementById('close-modal-button');
        const modalLoading = document.getElementById('modal-loading');
        const modalResult = document.getElementById('modal-result');
        const resultImage = document.getElementById('result-image');
        const modalError = document.getElementById('modal-error');
        const errorText = document.getElementById('error-text');
        const modalStatusText = document.getElementById('modal-status-text');


        onAuthStateChanged(auth, (user) => {
            if (user) {
                currentUser = user;
                const userDocRef = doc(db, "users", user.uid);
                getDoc(userDocRef).then(docSnap => {
                    if (docSnap.exists()) {
                        currentUser.displayName = docSnap.data().fullname;
                        currentUser.photoForTryOn = docSnap.data().photoForTryOn;
                    }
                    setupTryOnSection();
                });
            } else {
                currentUser = null;
                setupTryOnSection();
            }
        });
        
        const displayProductDetails = (product) => {
            currentProductImageUrl = product.imageUrl;

            const colorsHtml = (product.colors && product.colors.length > 0)
                ? product.colors.map(color => `<button class="h-8 w-8 rounded-full border-2 border-gray-200 focus:outline-none focus:ring-2 focus:ring-aurea-gold" style="background-color: ${color};" title="${color}"></button>`).join('')
                : '<p class="text-sm text-aurea-charcoal/70">No hay colores especificados.</p>';
                
            const stockHtml = product.stock !== undefined ? (product.stock > 0 ? `<p class="text-sm font-medium ${product.stock < 10 ? 'text-red-600' : 'text-green-600'}">¡Quedan ${product.stock} en stock!</p>` : '<p class="text-sm font-medium text-red-600">Agotado</p>') : '<p class="text-sm font-medium text-aurea-charcoal/70">Disponibilidad no especificada.</p>';
            
            productDetailContainer.innerHTML = `
                <div>
                    <div class="aspect-w-1 aspect-h-1 w-full overflow-hidden rounded-lg bg-gray-200">
                        <img src="${product.imageUrl || 'https://placehold.co/600x600/d3d3d3/222222?text=Producto'}" alt="${product.name}" class="h-full w-full object-cover object-center">
                    </div>
                </div>
                <div class="space-y-6">
                    <div>
                        <p class="text-sm font-medium text-aurea-charcoal/60">${product.category || 'Categoría'}</p>
                        <h1 class="text-3xl font-bold tracking-tight text-aurea-charcoal mt-2">${product.name || 'Nombre del Producto'}</h1>
                    </div>
                    <div><p class="text-4xl font-bold text-aurea-gold">$${product.price ? product.price.toFixed(2) : '0.00'}</p></div>
                    <div class="space-y-2">
                        <h3 class="text-sm font-medium text-aurea-charcoal">Color</h3>
                        <div class="flex items-center space-x-3">${colorsHtml}</div>
                    </div>
                     <div class="space-y-2">
                        <h3 class="text-sm font-medium text-aurea-charcoal">Disponibilidad</h3>
                        ${stockHtml}
                    </div>
                    <div class="space-y-4 text-aurea-charcoal/80 pt-4 border-t">
                        <h2 class="text-lg font-semibold text-aurea-charcoal">Descripción</h2>
                        <p>${product.description || 'No hay descripción disponible.'}</p>
                    </div>
                    <div>
                        <button class="w-full flex justify-center py-3 px-4 border border-transparent rounded-lg shadow-sm text-sm font-bold text-aurea-white bg-aurea-charcoal hover:bg-aurea-charcoal/90 disabled:bg-gray-400 transition" ${product.stock === 0 ? 'disabled' : ''}>
                            ${product.stock === 0 ? 'Agotado' : 'Añadir al Carrito'}
                        </button>
                    </div>

                    <div class="mt-8 pt-6 border-t border-aurea-neutral-gray/50">
                        <h3 class="text-lg font-semibold text-aurea-charcoal">Probador Virtual con IA</h3>
                        <div id="tryon-container" class="mt-4 space-y-3">
                            <!-- Esta sección se llenará dinámicamente -->
                        </div>
                    </div>
                </div>`;
            
            reviewsSection.classList.remove('hidden');
        };
        
        const displayReviews = (reviews) => {
            if (reviews.length === 0) {
                reviewsList.innerHTML = '<p class="text-sm text-aurea-charcoal/70">Aún no hay reseñas. ¡Sé el primero!</p>';
                return;
            }
            reviewsList.innerHTML = reviews.map(review => {
                const stars = '★'.repeat(review.rating) + '☆'.repeat(5 - review.rating);
                return `<div class="border-t border-aurea-neutral-gray/50 pt-4"><div class="flex items-center"><p class="text-yellow-400 text-xl">${stars}</p><p class="ml-4 font-semibold text-aurea-charcoal">${review.userName || 'Anónimo'}</p></div><p class="mt-2 text-aurea-charcoal/80">${review.comment}</p></div>`;
            }).join('');
        };

        const fetchAndDisplayReviews = async (productId) => {
            try {
                const reviewsQuery = query(collection(db, "products", productId, "reviews"), orderBy("createdAt", "desc"));
                const querySnapshot = await getDocs(reviewsQuery);
                const reviews = [];
                querySnapshot.forEach((doc) => {
                    reviews.push(doc.data());
                });
                displayReviews(reviews);
            } catch (error) {
                console.error("Error al obtener las reseñas:", error);
                reviewsList.innerHTML = '<p class="text-sm text-red-600">No se pudieron cargar las reseñas.</p>';
            }
        };

        const fetchProductDetails = async () => {
            const urlParams = new URLSearchParams(window.location.search);
            currentProductId = urlParams.get('id');

            if (!currentProductId) {
                productDetailContainer.innerHTML = '<p class="text-center col-span-full text-red-600 font-semibold">Producto no especificado.</p>';
                return;
            }

            try {
                const docRef = doc(db, "products", currentProductId);
                const docSnap = await getDoc(docRef);

                if (docSnap.exists()) {
                    displayProductDetails({ id: docSnap.id, ...docSnap.data() });
                    setupTryOnSection();
                    await fetchAndDisplayReviews(currentProductId);
                } else {
                    productDetailContainer.innerHTML = '<p class="text-center col-span-full text-aurea-charcoal/70">Producto no encontrado.</p>';
                }
            } catch (error) {
                console.error("Error al obtener el producto:", error);
                productDetailContainer.innerHTML = '<p class="text-center col-span-full text-red-600 font-semibold">Error al cargar el producto.</p>';
            }
        };
        
        const API_KEY = 'XXVcS-uh74S0UXVSfa_2rA';
        const API_URL = 'https://api.glam.ai/api/v1/tryon';

        function setupTryOnSection() {
            const container = document.getElementById('tryon-container');
            if (!container) return;

            if (currentUser && currentUser.photoForTryOn) {
                container.innerHTML = `
                    <p class="text-sm text-aurea-charcoal/70">Usa tu foto guardada o sube una nueva.</p>
                    <div class="flex items-center space-x-4 p-2 border rounded-lg">
                        <img src="${currentUser.photoForTryOn}" class="h-16 w-16 rounded-md object-cover">
                        <div class="flex-grow">
                            <button id="use-saved-photo-btn" class="w-full text-sm font-bold text-aurea-charcoal bg-aurea-gold hover:bg-aurea-gold/90 py-2 px-4 rounded-lg transition">Usar mi foto guardada</button>
                        </div>
                    </div>
                    <button id="change-photo-btn" class="text-sm text-aurea-gold hover:underline">Subir una foto nueva</button>
                `;
                document.getElementById('use-saved-photo-btn').addEventListener('click', () => handleVirtualTryOn(currentUser.photoForTryOn));
                document.getElementById('change-photo-btn').addEventListener('click', () => renderUploadView(true));
            } else {
                renderUploadView(false);
            }
        }

        function renderUploadView(isChanging) {
            const container = document.getElementById('tryon-container');
            if (!container) return;
            
            const message = isChanging ? 'Sube tu nueva foto para probarla.' : 'Sube una foto tuya (cuerpo completo) para ver cómo te queda.';
            container.innerHTML = `
                <p class="text-sm text-aurea-charcoal/70">${message}</p>
                <div>
                    <input type="file" id="user-image-upload" accept="image/*" class="block w-full text-sm text-aurea-charcoal/80 file:mr-4 file:py-2 file:px-4 file:rounded-lg file:border-0 file:text-sm file:font-semibold file:bg-aurea-gold/20 file:text-aurea-gold hover:file:bg-aurea-gold/30 cursor-pointer"/>
                </div>
                <div id="save-photo-container" class="${currentUser ? '' : 'hidden'} pt-1">
                    <label class="flex items-center text-sm cursor-pointer">
                        <input type="checkbox" id="save-photo-checkbox" class="h-4 w-4 rounded border-gray-300 text-aurea-gold focus:ring-aurea-gold">
                        <span class="ml-2 text-aurea-charcoal/80">Guardar esta foto para futuros usos</span>
                    </label>
                </div>
                <button id="upload-tryon-button" class="w-full flex justify-center py-2 px-4 rounded-lg shadow-sm text-sm font-bold text-aurea-charcoal bg-aurea-gold hover:bg-aurea-gold/90 transition">Subir y Probar</button>
                <p id="tryon-error-text" class="text-xs text-red-600 text-center"></p>
            `;
             document.getElementById('upload-tryon-button').addEventListener('click', handleUploadAndTryOn);
        }

        async function handleUploadAndTryOn() {
            const fileInput = document.getElementById('user-image-upload');
            const errorTextElem = document.getElementById('tryon-error-text');
            const file = fileInput.files[0];

            if (!file) {
                errorTextElem.textContent = 'Por favor, selecciona un archivo de imagen.';
                return;
            }
            errorTextElem.textContent = '';
            
            modalStatusText.textContent = 'Subiendo tu imagen...';
            resetModal();
            tryOnModal.classList.remove('hidden');

            try {
                const storageRef = ref(storage, `tryOnImages/${currentUser?.uid || 'guests'}/${Date.now()}-${file.name}`);
                await uploadBytes(storageRef, file);
                const downloadURL = await getDownloadURL(storageRef);

                const savePhotoCheckbox = document.getElementById('save-photo-checkbox');
                if (currentUser && savePhotoCheckbox?.checked) {
                    const userDocRef = doc(db, "users", currentUser.uid);
                    await updateDoc(userDocRef, { photoForTryOn: downloadURL });
                    currentUser.photoForTryOn = downloadURL; // Update local state
                }

                await handleVirtualTryOn(downloadURL);

            } catch(error) {
                console.error("Error al subir imagen:", error);
                showModalError('No se pudo subir tu imagen. Inténtalo de nuevo.');
            }
        }
        
        async function handleVirtualTryOn(userImageUrl) {
            resetModal();
            tryOnModal.classList.remove('hidden');

            const options = {
                method: 'POST',
                headers: { 'accept': 'application/json', 'content-type': 'application/json', 'X-API-Key': API_KEY },
                body: JSON.stringify({ mask_type: 'overall', media_url: userImageUrl, garment_url: currentProductImageUrl })
            };

            try {
                const response = await fetch(API_URL, options);
                if (!response.ok) throw new Error(`Error en la API: ${response.statusText}`);
                const data = await response.json();
                if (data.event_id) {
                    await pollForResult(data.event_id);
                } else {
                    throw new Error('La API no devolvió un event_id.');
                }
            } catch (err) {
                console.error('Error al iniciar probador virtual:', err);
                showModalError('No se pudo iniciar el proceso. Verifica tu conexión.');
            }
        }
        
        function resetModal() {
            modalLoading.style.display = 'block';
            modalResult.classList.add('hidden');
            modalError.classList.add('hidden');
        }

        function showModalError(message) {
            modalLoading.style.display = 'none';
            errorText.textContent = message;
            modalError.classList.remove('hidden');
        }

        async function pollForResult(eventId) {
            modalStatusText.textContent = 'Procesando tu imagen...';
            pollingInterval = setInterval(async () => {
                try {
                    const response = await fetch(`${API_URL}/${eventId}`, { headers: { 'X-API-Key': API_KEY, 'accept': 'application/json' } });
                    if (!response.ok) throw new Error(`Error en la API: ${response.statusText}`);
                    const result = await response.json();
                    
                    modalStatusText.textContent = `Estado: ${result.status}`;

                    if (result.status === 'READY') {
                        clearInterval(pollingInterval);
                        modalLoading.style.display = 'none';
                        resultImage.src = result.media_urls[0];
                        modalResult.classList.remove('hidden');
                    } else if (result.status === 'FAILED') {
                        clearInterval(pollingInterval);
                        showModalError('La generación de la imagen ha fallado. Intenta con otra foto.');
                    }
                } catch (error) {
                    clearInterval(pollingInterval);
                    console.error('Error durante el polling:', error);
                    showModalError('No se pudo obtener el resultado.');
                }
            }, 3000);
        }
        
        closeModalButton.addEventListener('click', () => {
            tryOnModal.classList.add('hidden');
            if (pollingInterval) clearInterval(pollingInterval);
        });

        reviewForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            if (!currentUser) {
                reviewStatus.textContent = 'Debes iniciar sesión para dejar una reseña.';
                reviewStatus.className = 'text-red-600';
                return;
            }
            const rating = reviewForm.rating.value;
            const comment = reviewForm.comment.value;
            if (!rating) {
                reviewStatus.textContent = 'Por favor, selecciona una calificación.';
                reviewStatus.className = 'text-red-600';
                return;
            }
            const submitButton = reviewForm.querySelector('button');
            submitButton.disabled = true;
            submitButton.textContent = 'Enviando...';
            try {
                await addDoc(collection(db, "products", currentProductId, "reviews"), {
                    userId: currentUser.uid,
                    userName: currentUser.displayName || 'Usuario de Áurea',
                    rating: Number(rating),
                    comment: comment,
                    createdAt: serverTimestamp()
                });
                reviewForm.reset();
                reviewStatus.textContent = '¡Gracias por tu reseña!';
                reviewStatus.className = 'text-green-600';
                await fetchAndDisplayReviews(currentProductId);
            } catch (error) {
                reviewStatus.textContent = 'Hubo un error al enviar tu reseña.';
                reviewStatus.className = 'text-red-600';
            } finally {
                submitButton.disabled = false;
                submitButton.textContent = 'Enviar reseña';
                 setTimeout(() => { reviewStatus.textContent = ''; }, 3000);
            }
        });

        document.addEventListener('DOMContentLoaded', fetchProductDetails);
    </script>
</body>
</html>

